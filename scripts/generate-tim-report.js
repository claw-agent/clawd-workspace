#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const RESEARCH_DIR = '/Users/marbagent/clawd/research';
const OUTPUT_DIR = '/Users/marbagent/clawd/reports';

const TEMPLATE = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      color: #1a1a2e;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
      background: #fff;
    }
    .cover {
      text-align: center;
      padding: 60px 0;
      border-bottom: 3px solid #10b981;
      margin-bottom: 40px;
    }
    .cover h1 {
      font-size: 2.2em;
      margin: 0;
      color: #10b981;
    }
    .cover .subtitle {
      font-size: 1.1em;
      color: #64748b;
      margin-top: 15px;
    }
    h1 { font-size: 1.6em; color: #1e293b; margin-top: 40px; border-bottom: 2px solid #10b981; padding-bottom: 8px; }
    h2 { font-size: 1.3em; color: #10b981; }
    h3 { font-size: 1.1em; color: #475569; }
    code { background: #1e293b; color: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
    pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85em; }
    pre code { background: none; padding: 0; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #10b981; color: white; }
    ul, ol { padding-left: 20px; }
    li { margin: 8px 0; }
    .footer { text-align: center; padding: 30px; color: #94a3b8; border-top: 1px solid #e2e8f0; margin-top: 40px; }
    .section { margin-bottom: 50px; page-break-inside: avoid; }
    .section-header { background: #10b981; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; }
    .section-content { background: #f8fafc; padding: 20px; border-radius: 0 0 8px 8px; border: 1px solid #e2e8f0; border-top: none; }
  </style>
</head>
<body>
  {{CONTENT}}
  <div class="footer">Generated by Claw üêæ for Tim ‚Ä¢ {{DATE}}</div>
</body>
</html>
`;

async function generateReport() {
  const files = fs.readdirSync(RESEARCH_DIR)
    .filter(f => f.startsWith('tim-') && f.endsWith('.md'))
    .sort();
  
  if (files.length === 0) {
    console.error('No Tim research files found!');
    process.exit(1);
  }
  
  console.log('Found', files.length, 'Tim research files');
  
  const date = new Date().toLocaleDateString('en-US', { 
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
    hour: '2-digit', minute: '2-digit', timeZone: 'America/Denver' 
  });
  
  const toc = files.map((f, i) => {
    const name = f.replace('tim-', '').replace('.md', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    return `<li>${i + 1}. ${name}</li>`;
  }).join('\n');
  
  const cover = `
    <div class="cover">
      <h1>üì± Tim's Realm - Payment & Refund Research</h1>
      <div class="subtitle">Apple IAP, Stripe, and Alternative Mechanisms</div>
      <div class="subtitle" style="margin-top:10px;font-size:0.9em;">${date}</div>
    </div>
    <div style="background:#f8fafc;padding:20px;border-radius:8px;margin-bottom:30px;">
      <h3 style="margin-top:0;color:#10b981;">üìë Contents</h3>
      <ul>${toc}</ul>
    </div>
  `;
  
  const sections = files.map((f, i) => {
    let content = fs.readFileSync(path.join(RESEARCH_DIR, f), 'utf-8');
    const name = f.replace('tim-', '').replace('.md', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    
    content = content
      .replace(/^### (.*$)/gm, '<h3>$1</h3>')
      .replace(/^## (.*$)/gm, '<h2>$1</h2>')
      .replace(/^# (.*$)/gm, '<h1>$1</h1>')
      .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/^\s*[-*]\s+(.*)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
      .replace(/\n\n/g, '</p><p>');
    
    return `
      <div class="section">
        <div class="section-header">
          <h2 style="margin:0;color:white;">${i + 1}. ${name}</h2>
        </div>
        <div class="section-content">
          <p>${content}</p>
        </div>
      </div>
    `;
  }).join('\n');
  
  const html = TEMPLATE
    .replace('{{CONTENT}}', cover + sections)
    .replace('{{DATE}}', date);
  
  // Write HTML
  const htmlPath = path.join(OUTPUT_DIR, 'tim-realm-report.html');
  fs.writeFileSync(htmlPath, html);
  console.log('HTML saved to', htmlPath);
  
  // Generate PDF
  try {
    const puppeteer = require('puppeteer');
    const browser = await puppeteer.launch({ headless: true });
    const page = await browser.newPage();
    await page.setContent(html, { waitUntil: 'networkidle0' });
    const pdfPath = path.join(OUTPUT_DIR, 'tim-realm-report-2026-01-24.pdf');
    await page.pdf({ 
      path: pdfPath, 
      format: 'A4', 
      margin: { top: '20mm', bottom: '20mm', left: '15mm', right: '15mm' }, 
      printBackground: true 
    });
    await browser.close();
    console.log('PDF saved to', pdfPath);
    return pdfPath;
  } catch (err) {
    console.error('PDF generation failed:', err.message);
    process.exit(1);
  }
}

generateReport();
